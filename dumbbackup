#!/bin/sh

# TODO
# - cleanup old backups (keep X dailies, and Y monthlies)
#   (for a monthly, keep the oldest in that month)
# - test what happens with weird directories (e.g. with space in the name)
USAGE="Usage: $0 [ --store=dir ] [ --check ] [ --cleanup ] [ --nice=N ] [ --rsync-opts=OPTS ] [ --exclude=PATTERN ] dir1 dir2 ..."

# defaults
STORE="/backup"
IONICE=0
NICE=0
KEEP_DAYS=10
KEEP_MONTHS=6

# command-line options
OPTS=`getopt -o X: --long store:,exclude:,rsync-opts:,log,check,nice:,ionice:,cleanup,keep-days:,keep-months: -n "$0" -- "$@"`
if [ $? != 0 ] ; then
    echo $USAGE >&2
    exit 1
fi

eval set -- "$OPTS"
while true ; do
    case "$1" in
        -X|--exclude)
            FILTERS="$FILTERS --exclude=$2"
            shift 2 ;;
        --store)
            STORE="$2"
            shift 2 ;;
        --rsync-opts)
            RSYNC_OPTS="$RSYNC_OPTS $2"
            shift 2 ;;
        --log)
            DO_LOG=1
            shift ;;
        --check)
            DO_CHECK=1
            shift ;;
        --cleanup)
            DO_CLEANUP=1
            shift ;;
        --nice)
            NICE=$2
            shift 2 ;;
        --ionice)
            NICE=$2
            shift 2 ;;
        --keep-days)
            KEEP_DAYS=$2
            shift 2 ;;
        --keep-months)
            KEEP_MONTHS=$2
            shift 2 ;;
        --) shift ; break ;;
        *)
            echo "Internal error!" >&2
            echo $USAGE            >&2
            exit 1 ;;
    esac
done
FILTERS="$FILTERS --exclude=$STORE"

# directories
TODAY=`date +%Y-%m-%d`
DEST=$STORE/$TODAY
PREV=`ls -d $STORE/????-??-?? | sort | grep -v "$DEST" | tail -1`

# rsync options
RSYNC_OPTS="$RSYNC_OPTS -aH --partial"
if [ "$DO_LOG" ] ; then
    RSYNC_OPTS="$RSYNC_OPTS --log-file=$STORE/$TODAY.log"
fi
if [ -d "$PREV" ] ; then
    RSYNC_OPTS="$RSYNC_OPTS --link-dest=$PREV/"
fi

# remaining arguments are a list of directories to backup
for SRC ; do
    SRC="$SRC/**"
    while [ "$SRC" != '/' ] ; do
        FILTERS="$FILTERS --include=$SRC"
        SRC=`dirname "$SRC"`
    done
done
FILTERS="$FILTERS --exclude=*"

# perform the actual backup
CMD="rsync $RSYNC_OPTS $FILTERS / $DEST"
if [ "$DO_CHECK" ] ; then
    echo $CMD
else
    ionice -c $IONICE nice -n $NICE $CMD
fi

# cleanup
if [ "$DO_CLEANUP" ] ; then
    # make the list of backups to delete
    DELETE=`perl -l - << \PERL $KEEP_MONTHS $KEEP_DAYS $STORE
    my ($months, $days, $dir) = @ARGV;
    my ( %m, %k );
    @dirs = sort glob "$dir/????-??-??";
    /\b(\d{4}-\d{2})-\d{2}$/ and push @{ $m{$1} }, $_
      for @dirs;
    $k{$_}++ for grep $_, ( reverse @dirs )[ 0 .. $days - 1 ];
    $k{ $m{$_}[0] }++ for grep $_, ( reverse sort keys %m )[ 0 .. $months - 1 ];
    print for grep !$k{$_}, @dirs;
PERL
`

    # do the delete
    for bye in $DELETE ; do
        if [ "$DO_CHECK" ] ; then
            echo rm -rf "$bye" "$bye.log"
        else
            ionice -c $IONICE rm -rf "$bye" "$bye.log"
        fi
    done
fi
