#!/bin/sh

# TODO
# - more dumbbackup options (using getopt(1))
# - more exclude options, actually
# - cleanup old backups (keep X dailies, and Y monthlies)
#   (for a monthly, keep the oldest in that month)

# directories
BACKUP="/backup"
DEST=$BACKUP/`date +%Y-%m-%d`
PREV=`ls -d $BACKUP/????-??-?? | sort | grep -v "$DEST" | tail -1`

# options
OPTS="-aH --partial --log-file=$BACKUP/`date +%Y-%m-%d`.log"
if [ -d "$PREV" ] ; then
    OPTS="$OPTS --link-dest=$PREV/"
fi

# stuff to backup is a list of directories given on the command-line
for SRC in $* ; do
    SRC="$SRC/**"
    while [ "$SRC" != '/' ] ; do
        FILTERS="$FILTERS --include=$SRC"
        SRC=`dirname "$SRC"`
    done
done
FILTERS="$FILTERS --exclude=*"

# perform the actual backup
rsync $OPTS $FILTERS / $DEST
